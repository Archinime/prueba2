<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- A√±adido id para cambiar din√°micamente si fuera necesario -->
  <meta name="viewport" id="viewport-meta" content="width=device-width, initial-scale=1">
  <title>Archinime</title>

  <link rel="icon" href="Logo_Archinime.png" type="image/png">

  <!-- Preload del video y poster para mejorar la percepci√≥n de carga -->
  <link rel="preload" as="video" href="galaxia.mp4" type="video/mp4">
  <link rel="preload" as="image" href="galaxia-poster.jpg">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{
      height:100%;
      overflow-x:hidden;
      overflow-y:auto;
      font-family:sans-serif;
      color:#fff;
    }

    /* Fondo galaxia
       - video debe estar detr√°s de todo (-2)
       - overlay ocupa la parte superior (-1) mientras carga y luego se oculta (display:none)
    */
    #bg-video{
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      z-index:-2;                  /* detr√°s del overlay y dem√°s */
      will-change: opacity, transform;
      opacity:0;                   /* oculto hasta que est√© realmente reproduci√©ndose */
      transition:opacity .6s ease;
      background:#000;             /* color de fallback mientras se carga */
      pointer-events:none;
    }

    #overlay{
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      z-index:-1;                  /* encima del video al inicio */
      will-change: background, opacity;
      background: url('galaxia-poster.jpg') center/cover no-repeat,
                  linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6));
      opacity:1;
      transition:opacity .6s ease;
      pointer-events:none;         /* no bloquear clicks que necesiten autoplay */
    }

    /* Bot√≥n circular de apoyo */
    #support {
      position: fixed; bottom:1rem; right:1rem;
      text-align:center; z-index:11;
    }
    #tiktok-btn, #youtube-btn {
      width:60px; height:60px; border:none;
      border-radius:50%; background:#fff;
      padding:0; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.5);
      transition:transform .2s; overflow:hidden;
    }
    #tiktok-btn:hover, #youtube-btn:hover { transform:scale(1.1); }
    #tiktok-btn img, #youtube-btn img { width:100%;height:100%;object-fit:cover; }
    #support-text{
      margin-top:.4rem; font-size:.9rem;
      color:#0ff; text-shadow:1px 1px 2px #000;
      font-weight:bold; white-space:nowrap;
    }

    /* Header */
    header{
      position:sticky; top:0; padding:1rem 2rem;
      display:flex; align-items:center; gap:1rem;
      background:rgba(0,0,0,0.7); backdrop-filter:blur(5px);
      z-index:10; transition:background .3s;
      /* permitimos que otros elementos puedan envolver, pero protegeremos el t√≠tulo */
      flex-wrap:wrap;
    }
    header.scrolled{background:rgba(0,0,0,0.95);}
    /* T√≠tulo + logo: forzar que se mantengan en la misma l√≠nea siempre */
    header h1{
      cursor:pointer; 
      font-size:1.8rem;
      font-weight: 800;

      background: linear-gradient(135deg, #00fff7, #ff00cc, #ffd700);
      background-size:300% 300%;
      -webkit-background-clip:text; 
      background-clip:text;
      -webkit-text-fill-color:transparent;
      display:flex; align-items:center; gap:.6rem;
      flex:0 0 auto;             /* evita que el h1 se reduzca/encole o salte a otra l√≠nea */
      white-space:nowrap;        /* evita el quiebre de l√≠nea entre logo y texto */
      animation: gradientMove 6s ease infinite, fadeIn 2s ease-in-out;
    }

    /* Logo peque√±o al lado del t√≠tulo */
    header h1 img#logo {
      width:42px;
      height:42px;
      object-fit:contain;
      border-radius:6px;
      background:transparent;
      display:block;
      flex:0 0 auto;
    }
    header h1 img#logo {
      width:42px;
      height:42px;
      object-fit:contain;
      border-radius:6px;
      background:transparent;
      display:block;
    }
    header select, header input{
      padding:.5rem 1rem; border:none; border-radius:5px;
      font-size:1rem; transition:box-shadow .3s;
      background:rgba(255,255,255,0.9); color:#000;
    }
    header select:focus, header input:focus{
      box-shadow:0 0 8px #0ff;
    }
    #search{width:200px;}
    .container{max-width:1200px;margin:6rem auto 2rem;padding:0 2rem;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1.5rem;}
    .card{
      opacity:0; transform:translateY(30px);
      transition:all .6s ease-out; cursor:pointer;
      border-radius:10px; overflow:hidden; position:relative;
      will-change: opacity, transform;
    }
    .card.visible{opacity:1;transform:translateY(0);}
    .card img{
      width:100%; display:block;
      filter:brightness(100%);
      transition:transform .4s,filter .4s;
    }
    .card:hover img{
      transform:scale(1.05); filter:brightness(75%);
    }
    .info{
      position:absolute; bottom:0; left:0; right:0;
      background:rgba(0,0,0,0.7); padding:.75rem;
      transform:translateY(100%); transition:transform .3s;
    }
    .card:hover .info{transform:translateY(0);}
    .info strong{display:block;font-size:1.05rem;margin-bottom:.25rem;}
    .info span{
      background:#0ff; color:#000;
      padding:2px 6px; border-radius:4px; font-size:.85rem;
    }

    /* ------------------ RESULTS: barra colorida, iluminada e interactiva ------------------ */
    .results-wrapper {
      margin-left: auto; display:flex; align-items:center; gap:0.6rem;
      position:relative; z-index:12;
    }
    .results-badge {
      display:flex; align-items:center; gap:.6rem; padding:.5rem .9rem;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,0,150,0.12), rgba(0,200,255,0.12));
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 30px rgba(0,0,0,0.5), 0 0 18px rgba(255,0,150,0.06) inset;
      backdrop-filter: blur(6px);
      cursor:pointer; transition: transform .18s ease, box-shadow .18s ease;
      user-select:none;
    }
    .results-badge:hover{ transform: translateY(-3px) scale(1.02); box-shadow: 0 14px 44px rgba(0,0,0,0.6); }
    .badge-glow {
      width:12px; height:12px; border-radius:50%;
      background: linear-gradient(45deg,#ff007a,#ffd700,#00fff7);
      box-shadow: 0 0 18px #ff007a, 0 0 34px #ffd700, 0 0 70px #00fff7;
      animation: pulseGlow 2.4s infinite;
      flex:0 0 auto;
    }
    @keyframes pulseGlow {
      0% { transform: scale(.9); opacity:.9; }
      50% { transform: scale(1.18); opacity:1; }
      100% { transform: scale(.9); opacity:.9; }
    }

    .results-text { display:flex; flex-direction:column; line-height:1; text-align:left; }
    .results-text .label {
      font-size:0.78rem; opacity:0.95; font-weight:800;
      text-transform:uppercase; letter-spacing:0.06em; color:#f8f8f8;
    }
    .results-text .count {
      font-size:1rem; font-weight:900;
      background:linear-gradient(90deg,#ffffff 0%, #ffd700 50%, #00fff7 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow: 0 4px 18px rgba(0,0,0,0.5);
    }

    .results-panel {
      position:absolute; right:0; top:calc(100% + .6rem);
      min-width:260px; max-width:360px; background:rgba(2,2,6,0.9);
      border-radius:10px; padding:.8rem; box-shadow:0 20px 50px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
      transform-origin: top right;
      opacity:0; visibility:hidden; transform: translateY(-6px) scale(.98);
      transition:opacity .18s ease, transform .18s ease, visibility .18s;
      z-index:13;
    }
    .results-panel.open { opacity:1; visibility:visible; transform: translateY(0) scale(1); }
    .results-panel h4 { margin-bottom:.4rem; font-size:0.95rem; }
    .filter-line { display:flex; justify-content:space-between; gap:.6rem; margin:.35rem 0; align-items:center; }
    .small-tag { background:rgba(255,255,255,0.04); padding:.28rem .6rem; border-radius:6px; font-size:.84rem; }

    .clear-btn {
      margin-top:.6rem; display:inline-block; padding:.55rem .7rem; border-radius:10px;
      background:linear-gradient(90deg,#ff476e,#8b5cf6); color:#fff; border:none; cursor:pointer;
      box-shadow:0 12px 40px rgba(139,92,246,0.12); font-weight:800;
      transition:transform .12s ease;
    }
    .clear-btn:hover{ transform:translateY(-3px); }

    /* ------------------ NO-RESULTS estilado, colorido e interactivo ------------------ */
    .no-results {
      grid-column: 1 / -1;
      padding: 2.6rem;
      border-radius: 14px;
      display:flex;
      gap:1.25rem;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.3)),
        radial-gradient(1200px 400px at -10% 10%, rgba(0,255,255,0.04), transparent 10%),
        radial-gradient(900px 300px at 110% 90%, rgba(255,0,150,0.03), transparent 10%);
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: 0 18px 60px rgba(0,0,0,0.6);
      text-align:center;
      transition: transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .2s;
    }
    .no-results:hover{ transform:translateY(-6px); box-shadow:0 28px 80px rgba(0,0,0,0.66); }

    .no-results .title {
      font-size:1.45rem; font-weight:900;
      background: linear-gradient(90deg,#fff 0%, #ffd700 50%, #00fff7 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow: 0 6px 26px rgba(0,0,0,0.6);
      margin-bottom:0.35rem;
    }
    .no-results .subtitle {
      font-size:1rem; color:rgba(255,255,255,0.86);
      max-width:780px; line-height:1.4; margin-bottom:1rem;
      text-shadow: 0 2px 14px rgba(0,0,0,0.45);
    }

    .no-results .sparkles {
      display:flex; gap:0.5rem; align-items:center;
    }
    .btn-reset {
      padding:.6rem .9rem; border-radius:10px; border:none; font-weight:800;
      background:linear-gradient(90deg,#00fff7,#8b5cf6); color:#04111a; cursor:pointer;
      box-shadow:0 14px 46px rgba(0,255,247,0.06); transition: transform .12s ease;
    }
    .btn-reset:hover{ transform:translateY(-3px); }

    /* shimmer (brillo) en el mensaje */
    .shimmer {
      position:relative; overflow:hidden; display:inline-block;
    }
    .shimmer:after {
      content:""; position:absolute; left:-120%; top:0; height:100%; width:120%;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.18) 50%, rgba(255,255,255,0) 100%);
      transform:skewX(-18deg);
      animation: shimmerMove 2.6s linear infinite;
      pointer-events:none;
    }
    @keyframes shimmerMove { to { left:120%; } }
/* --- Popup compacto para selects (fuera del @media, en el mismo <style>) --- */
.mobile-select-popup {
  position: absolute;
  z-index: 1200;
  background: rgba(2,2,6,0.98);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:8px;
  box-shadow:0 20px 50px rgba(0,0,0,0.6);
  max-height: 200px;     /* m√°s compacto: no ocupa toda la pantalla */
  min-width: 140px;
  overflow:auto;
  padding: 0.25rem;
  font-size: 0.92rem;
}

/* Opciones dentro del popup m√°s compactas */
.mobile-select-popup .opt {
  padding: .28rem .45rem;
  border-radius:6px;
  margin: .08rem 0;
  font-size:0.92rem;
  line-height:1.05;
  cursor:pointer;
}
.mobile-select-popup .opt[aria-selected="true"],
.mobile-select-popup .opt.selected { font-weight:700; }
.mobile-select-popup .opt:hover { background: rgba(255,255,255,0.03); }

    /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî Media query para m√≥viles (‚â§780px) ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
@media (max-width: 780px) {
  header {
    padding: 0.6rem 0.9rem;
    gap: 0.5rem;
    align-items: center;
  }
header h1 {
  margin-right: 0.6rem; /* prueba 0.6rem, sube a 0.9rem si quieres m√°s separaci√≥n */
}

/* Asegura que el wrapper de resultados no quede pegado al borde */
.results-wrapper {
  margin-left: 0.35rem; /* espacio extra entre controles y el badge */
  padding-left: 0;      /* prevenir desplazamientos no deseados */
}

/* Ajuste fino para pantallas muy peque√±as */
@media (max-width: 420px) {
  header h1 { margin-right: 0.45rem; }
  .results-wrapper { margin-left: 0.18rem; }
}

  /* Reordenamos: queremos que el t√≠tulo y el bot√≥n de resultados queden juntos en la primera fila,
     y que los selects / input se envuelvan debajo. Para no tocar el HTML, usamos order y flex. */

  /* Forzar que el t√≠tulo no se reduzca y quede en la primera fila */
  header h1{
    box-sizing: border-box;
    flex: 0 0 auto;
    order: 0;
    white-space: nowrap;
  }

  /* Colocamos la results-wrapper justo despu√©s del t√≠tulo */
  .results-wrapper {
    order: 1;
    flex: 0 0 auto;            /* ocupa el ancho que necesite junto al t√≠tulo */
    margin-left: 0;
    margin-right: .6rem;
    justify-content:flex-start;
    align-items:center;
    gap:.5rem;
  }

  /* El resto de controles (selects, input) van despu√©s y pueden ocupar dos por fila */
  header > :not(h1):not(.results-wrapper) {
    box-sizing: border-box;
    order: 2;
    flex: 0 0 calc(50% - 0.45rem);
    max-width: calc(50% - 0.45rem);
  }

  /* reduce padding y tama√±o de los inputs/selects para que entren 2 */
  header select, header input {
    padding: 0.42rem .6rem;
    font-size: 0.86rem;
    border-radius:6px;
  }
  #search{ width:100%; min-width:0; }

  /* Ajustes espec√≠ficos para la apariencia del badge en m√≥vil (m√°s compacto)
     y para que no empuje al t√≠tulo si hay poco espacio. */
  .results-badge { padding:.32rem .6rem; font-size:0.78rem; }
  .results-text .label{ font-size:0.6rem; }
  .results-text .count{ font-size:0.86rem; line-height:1; }

  /* grid m√°s compacto para mostrar m√°s miniaturas en pantalla */
  .grid {
    gap: 0.6rem;
    grid-template-columns: repeat(3, 1fr); /* 3 por fila en m√≥vil tambi√©n */
  }
  .card { aspect-ratio: 2 / 3; } /* mantiene proporci√≥n */
  .card img { object-fit: contain; }

  /* Aseguramos que el panel de filtros se posicione al lado del badge (no fuera de pantalla) */
  .results-panel {
    right: auto;
    left: 0;
    top: calc(100% + .4rem);
    min-width: 220px;
    max-width: 320px;
  }
}

/* ajuste extra para pantallas muy peque√±as (‚â§420px) */
@media (max-width: 420px) {
  header > :not(h1):not(.results-wrapper) {
    flex: 0 0 calc(50% - 0.35rem);
    max-width: calc(50% - 0.35rem);
  }
  .card img {
    height: 160px;
    object-fit: contain;
  }
  /* en pantallas muy peque√±as, reducimos a√∫n m√°s el badge para que quepa junto al t√≠tulo */
  .results-badge { padding:.28rem .46rem; font-size:0.72rem; gap:.4rem; }
  .results-text .label{ font-size:0.56rem; }
  .results-text .count{ font-size:0.82rem; }
  /* Si la pantalla es extremadamente angosta, el panel volver√° a alinearse a la derecha */
  .results-panel { left: auto; right: 0; top: calc(100% + .35rem); min-width:200px; max-width:260px; }
}

    /* Animaci√≥n del gradiente para el t√≠tulo (Archinime) */
    @keyframes gradientMove {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
@media (max-width: 780px) {
  .container{
    margin: 1rem auto 1rem;   /* espacio superior a√∫n menor en m√≥viles */
    padding: 0 0.9rem;
  }
    /* Contenedor adaptable para el frontal (sin marco visible).
       left/right posicionados din√°micamente por JS, siempre en esquina (nunca centro). */
    #fgContainer {
      position:fixed;
      bottom:20px;
      z-index:5;
      pointer-events:auto;
      display:flex; align-items:center; justify-content:center;
      transform: translateY(30px);
      opacity: 0;
      transition: transform 280ms ease-out, opacity 220ms ease-out, left 120ms, right 120ms;
      will-change: transform, opacity;
      overflow: hidden;
      min-width: 120px; min-height: 80px;
      max-width: calc(70vw); max-height: calc(70vh);
      box-shadow: none;
      background: transparent;
      border-radius: 0;
      touch-action: manipulation; /* mobile */
    }

    /* Entrada / salida */
    #fgContainer.enter { transform: translateY(0); opacity: 1; }
    #fgContainer.exit  { transform: translateY(60px); opacity: 0; }

    /* Canvas y v√≠deo: ocupan todo el contenedor. */
    canvas#fgCanvas, video#fgVideo {
      width:100%; height:100%; display:block;
      pointer-events:none;
      object-fit: contain; /* muestra todo el v√≠deo sin recortar */
      background: transparent;
    }
    /* canvas se activa cuando chroma OK */
    canvas#fgCanvas { display:none; }

    /* Controls (solo file://) */
    .controls {
      position:fixed; left:12px; bottom:12px; z-index:6;
      background: rgba(0,0,0,0.55); color:#fff; padding:10px; border-radius:8px;
      font-size:13px;
    }
    .controls label { display:block; margin:6px 0; }
    input[type=range]{ width:180px; }

    /* Play overlay */
    .play-overlay {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      z-index:9; pointer-events:auto;
    }
    .play-btn {
      background: rgba(0,0,0,0.7); color:#fff; border:2px solid #fff;
      padding:14px 22px; border-radius:12px; font-size:18px; cursor:pointer;
    }

    /* Mensajes */
    .notice { position:fixed; top:12px; right:12px; z-index:10; background:#ffb74d; color:#000; padding:8px 12px; border-radius:8px; font-weight:600; display:none; }
    .error  { position:fixed; top:12px; left:12px; z-index:10; background:#ff4d4d; color:#fff; padding:8px 12px; border-radius:8px; font-weight:600; display:none; }

    @media (max-width:420px) {
      #fgContainer { bottom:12px; }
    }
  </style>
</head>
<body>

  <!-- Fondo -->
  <video id="bg-video" poster="galaxia-poster.jpg" autoplay muted loop playsinline crossorigin="anonymous">
    <source src="https://www.dropbox.com/scl/fi/ex4qhvjtx54blr92d0saj/yyyy.mp4?rlkey=ip9vhlhlsl1ye7el3onl1u2ug&st=f8o90thc&raw=1" type="video/mp4">
  </video>
  <div id="overlay"></div>

  <audio id="bg-music" autoplay>
    <source src="https://www.dropbox.com/scl/fi/7lp1tkbioyyi3bj9mhq8y/TICK-TICK-TICK-TICK-TICK-BITE-Archinime.mp3?rlkey=vsg0gby24ceyakz88tnh7gt3f&st=e4yuprpe&raw=1" type="audio/mpeg">
    Tu navegador no soporta el audio.
  </audio>

  <!-- Soporte -->
  <div id="support">
    <button id="youtube-btn" type="button" aria-label="Abrir YouTube en nueva pesta√±a" onclick="openInNewTab('https://www.youtube.com/@Archinime-k2g')">
      <img src="youtube.jpg" alt="YouTube">
    </button>
    <button id="tiktok-btn" type="button" aria-label="Abrir TikTok en nueva pesta√±a" onclick="openInNewTab('https://www.tiktok.com/@archinime?_t=ZS-8zGoKE4IqLw&_r=1')">
      <img src="tiktok.jpg" alt="TikTok">
    </button>
    <div id="support-text">Sugi√©reme un anime üëÜ</div>
  </div>

  <header>
    <h1 onclick="location.reload()"><img id="logo" src="Logo_Archinime.png" alt="Logo"> Archinime</h1>
    <!-- selects y search (mismo HTML que ten√≠as) -->
    <select id="genre-select" onchange="filtro()">
      <option value="">Todos los g√©neros</option>
      <!-- ... tus opciones ... -->
    </select>
    <select id="demographic-select" onchange="filtro()">
      <option value="">Todas las demograf√≠as</option>
      <!-- ... -->
    </select>
    <select id="rating-select" onchange="filtro()">
      <option value="">‚≠ê Todas</option>
      <option value="excellent">‚≠ê Excelente (4.8‚Äì5.0)</option>
      <option value="good">‚≠ê Buena (4.6‚Äì4.7)</option>
      <option value="regular">‚≠ê Regular (&lt;4.5)</option>
    </select>
    <input id="search" placeholder="üîç Buscar anime‚Ä¶" oninput="debouncedFiltro()">
    <div class="results-wrapper" id="results-wrapper" aria-live="polite">
      <div class="results-badge" id="results-badge" role="button" aria-expanded="false" tabindex="0" title="Mostrar filtros aplicados">
        <span class="badge-glow" aria-hidden="true"></span>
        <div class="results-text">
          <div class="label">Resultados</div>
          <div class="count" id="results-count">0</div>
        </div>
      </div>
      <div class="results-panel" id="results-panel" aria-hidden="true">
        <h4>Filtros aplicados</h4>
        <div class="filter-line"><div>Busqueda</div><div id="panel-query" class="small-tag">‚Äî</div></div>
        <div class="filter-line"><div>G√©nero</div><div id="panel-genre" class="small-tag">‚Äî</div></div>
        <div class="filter-line"><div>Demograf√≠a</div><div id="panel-demo" class="small-tag">‚Äî</div></div>
        <div class="filter-line"><div>Valoraci√≥n</div><div id="panel-rating" class="small-tag">‚Äî</div></div>
        <button class="clear-btn" id="clear-filters">Limpiar filtros</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid" id="grid"></div>
  </main>

  <!-- Contenedor frontal: canvas + video -->
  <div id="fgContainer" aria-label="V√≠deo frontal">
    <canvas id="fgCanvas" style="display:none;"></canvas>
    <video id="fgVideo" muted loop playsinline crossorigin="anonymous" style="display:none;"></video>
  </div>

  <!-- Controles (solo file://) -->
  <div class="controls" id="controls" style="display:none;">
    <div style="font-weight:700; margin-bottom:6px;">Chroma key ‚Äî Ajustes (solo file://)</div>
    <label>Umbral de verde (sensibilidad): <span id="thVal">0.40</span>
      <input id="threshold" type="range" min="0.0" max="1.0" step="0.01" value="0.40">
    </label>
    <label>Diferencia m√≠nima G - max(R,B): <span id="diffVal">30</span>
      <input id="diff" type="range" min="0" max="255" step="1" value="30">
    </label>
    <label>Suavizado (bordes): <span id="softVal">30</span>
      <input id="soft" type="range" min="0" max="200" step="1" value="30">
    </label>
  </div>

  <div class="play-overlay" id="playOverlay" style="display:none;">
    <button class="play-btn" id="playBtn">Pulsar para iniciar</button>
  </div>

  <div id="noticeBox" class="notice" style="display:none;">Chroma-key no disponible; mostrando v√≠deo sin recorte.</div>
  <div id="errorBox" class="error" style="display:none;">Error procesando el v√≠deo frontal (no se pueden leer p√≠xeles).</div>

  <script>
    // ---------- helpers y estado ----------
    const protocol = location.protocol;
    const fgContainer = document.getElementById('fgContainer');
    const fgCanvas = document.getElementById('fgCanvas');
    const fgVideo = document.getElementById('fgVideo');
    const bgVideo = document.getElementById('bg-video');
    const ctx = fgCanvas.getContext('2d', { alpha: true });

    const controls = document.getElementById('controls');
    const thresholdEl = document.getElementById('threshold');
    const diffEl = document.getElementById('diff');
    const softEl = document.getElementById('soft');
    const thVal = document.getElementById('thVal');
    const diffVal = document.getElementById('diffVal');
    const softVal = document.getElementById('softVal');

    const playOverlay = document.getElementById('playOverlay');
    const playBtn = document.getElementById('playBtn');
    const noticeBox = document.getElementById('noticeBox');
    const errorBox = document.getElementById('errorBox');

    let off = document.createElement('canvas');
    let offCtx = off.getContext('2d');
    let animationId = null;
    let usingChroma = true;
    let scheduledTimer = null;
    let currentVideoObj = null;
    let lastObjectUrl = null; // para limpiar

    const videoList = [
      { id: 'hola', src: 'hola.mp4', preset: { threshold: 0.25, diff: 0, soft: 100 } },
      { id: 'rem',  src: 'rem.mp4',  preset: { threshold: 0.22, diff: 0, soft: 100 } }
    ];

    // ---------- utilidades ----------
    function isMobileScreen() { return window.matchMedia && window.matchMedia('(max-width:767px)').matches; }
    function pickRandomVideo(excludeId) {
      if (!videoList || videoList.length === 0) return null;
      if (videoList.length === 1) return videoList[0];
      const candidates = videoList.filter(v => v.id !== excludeId);
      return candidates.length ? candidates[Math.floor(Math.random()*candidates.length)] : videoList[Math.floor(Math.random()*videoList.length)];
    }
    function setupControlsByProtocol() { if (protocol === 'file:') controls.style.display = 'block'; else controls.style.display = 'none'; }

    function adjustContainerToVideo(video, infoObj) {
      const vw = video.videoWidth || 16;
      const vh = video.videoHeight || 9;
      const mobile = isMobileScreen();
      let maxW = Math.min(window.innerWidth * 0.7, 900);
      let maxH = Math.min(window.innerHeight * 0.7, 900);
      if (mobile && infoObj && infoObj.id === 'rem') {
        maxW = Math.min(window.innerWidth * 0.45, 360);
        maxH = Math.min(window.innerHeight * 0.45, 640);
      }
      const scale = Math.min(maxW / vw, maxH / vh, 1.0);
      const displayW = Math.max(120, Math.round(vw * scale));
      const displayH = Math.max(80, Math.round(vh * scale));
      fgContainer.style.width = displayW + 'px';
      fgContainer.style.height = displayH + 'px';
      fgCanvas.width = displayW;
      fgCanvas.height = displayH;
      const cap = 1280;
      off.width = Math.min(video.videoWidth || displayW * 2, cap);
      off.height = Math.min(video.videoHeight || displayH * 2, cap);
    }

    function applyChromaKey(imageData, settings) {
      const data = imageData.data;
      const len = data.length;
      const thresh = settings.threshold;
      const minDiff = settings.diff;
      const soften = settings.soft;
      for (let i = 0; i < len; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
        if (a === 0) continue;
        const maxrb = Math.max(r,b);
        const sum = r + g + b + 1;
        const greenScore = (g - maxrb) / sum;
        const isGreenCandidate = (g - maxrb) > minDiff && greenScore > (thresh - 0.2);
        if (!isGreenCandidate) {
          data[i+3] = 255;
          continue;
        }
        const diff = g - maxrb;
        if (soften <= 0) {
          data[i+3] = (diff > minDiff) ? 0 : 255;
        } else {
          const t = (diff - minDiff) / soften;
          const clamped = Math.max(0, Math.min(1, t));
          data[i+3] = Math.round((1 - clamped) * 255);
        }
      }
      return imageData;
    }

    function drawProcessedToScreen() {
      const cw = fgCanvas.width, ch = fgCanvas.height;
      const vw = off.width, vh = off.height;
      ctx.clearRect(0,0,cw,ch);
      if (vw === 0 || vh === 0) return;
      const scale = Math.min(cw / vw, ch / vh);
      const dw = Math.round(vw * scale);
      const dh = Math.round(vh * scale);
      const dx = Math.round((cw - dw) / 2);
      const dy = Math.round((ch - dh) / 2);
      ctx.drawImage(off, 0, 0, vw, vh, dx, dy, dw, dh);
    }

    // ---------- pruebas y fallback CORS ----------
    async function fetchAsObjectURL(url) {
      try {
        const resp = await fetch(url, { mode: 'cors' });
        if (!resp.ok) throw new Error('fetch fail ' + resp.status);
        const blob = await resp.blob();
        const obj = URL.createObjectURL(blob);
        return obj;
      } catch (err) {
        console.warn('fetchAsObjectURL fallo:', err);
        return null;
      }
    }

    function clearLastObjectURL() {
      if (lastObjectUrl) {
        try { URL.revokeObjectURL(lastObjectUrl); } catch(e){/*ignore*/ }
        lastObjectUrl = null;
      }
    }

    async function tryDrawTest(video) {
      // dibuja un frame y prueba getImageData para detectar CORS/taint
      try {
        const testW = Math.min(32, video.videoWidth || 32);
        const testH = Math.min(32, video.videoHeight || 32);
        off.width = testW;
        off.height = testH;
        offCtx.drawImage(video, 0, 0, off.width, off.height);
        // s√≥lo pedimos 1x1 para minimizar coste
        offCtx.getImageData(0, 0, 1, 1);
        return true;
      } catch (err) {
        console.warn('tryDrawTest detect√≥ problema (posible CORS):', err);
        return false;
      }
    }

    function activateFallback(message) {
      usingChroma = false;
      fgCanvas.style.display = 'none';
      fgVideo.style.display = 'block';
      noticeBox.textContent = message || 'Chroma-key no disponible; mostrando v√≠deo sin recorte.';
      noticeBox.style.display = 'block';
      errorBox.style.display = 'none';
      if (animationId) cancelAnimationFrame(animationId);
      fgVideo.play().catch(()=>{ playOverlay.style.display = 'flex'; });
      showContainer();
    }

    function activateError(message) {
      errorBox.textContent = message;
      errorBox.style.display = 'block';
      noticeBox.style.display = 'none';
    }

    // ---------- loop de proceso ----------
    function processLoop(video, infoObj) {
      if (!usingChroma) return;
      if (video.paused || video.ended) {
        animationId = requestAnimationFrame(()=>processLoop(video, infoObj));
        return;
      }
      if (video.videoWidth && video.videoHeight &&
          (off.width !== Math.min(video.videoWidth,1280) || off.height !== Math.min(video.videoHeight,1280))) {
        off.width = Math.min(video.videoWidth,1280);
        off.height = Math.min(video.videoHeight,1280);
      }

      try {
        offCtx.drawImage(video, 0, 0, off.width, off.height);
      } catch (err) {
        console.error('drawImage error (posible CORS):', err);
        activateFallback('No se pudieron leer p√≠xeles (CORS). Mostrando v√≠deo sin recorte.');
        return;
      }

      let frame;
      try {
        frame = offCtx.getImageData(0, 0, off.width, off.height);
      } catch (err) {
        console.error('getImageData error (CORS):', err);
        activateFallback('No se pudieron leer p√≠xeles (CORS). Mostrando v√≠deo sin recorte.');
        return;
      }

      let settings;
      if (protocol === 'file:') {
        settings = { threshold: parseFloat(thresholdEl.value), diff: parseInt(diffEl.value,10), soft: parseInt(softEl.value,10) };
      } else {
        settings = infoObj && infoObj.preset ? infoObj.preset : { threshold:0.4, diff:30, soft:30 };
      }
      thVal.textContent = settings.threshold.toFixed(2);
      diffVal.textContent = settings.diff;
      softVal.textContent = settings.soft;

      const processed = applyChromaKey(frame, settings);
      offCtx.putImageData(processed, 0, 0);
      drawProcessedToScreen();

      animationId = requestAnimationFrame(()=>processLoop(video, infoObj));
    }

    function placeContainerRandomly() {
      const leftOrRight = Math.random() < 0.5 ? 'left' : 'right';
      fgContainer.style.left = '';
      fgContainer.style.right = '';
      if (leftOrRight === 'left') fgContainer.style.left = (window.innerWidth < 420 ? '12px' : '20px');
      else fgContainer.style.right = (window.innerWidth < 420 ? '12px' : '20px');
      fgContainer.style.top = '';
      fgContainer.style.bottom = (window.innerWidth < 420 ? '12px' : '20px');
    }
    function showContainer() {
      placeContainerRandomly();
      fgContainer.style.display = 'flex';
      fgContainer.classList.remove('exit');
      requestAnimationFrame(()=> fgContainer.classList.add('enter'));
    }
    function hideContainerInstantlyForTransition() {
      fgContainer.classList.remove('enter');
      fgContainer.classList.add('exit');
    }

    function scheduleNextVideo(afterSeconds = 3, excludeId = null) {
      if (scheduledTimer) { clearTimeout(scheduledTimer); scheduledTimer = null; }
      hideContainerInstantlyForTransition();
      scheduledTimer = setTimeout(() => {
        const next = pickRandomVideo(excludeId);
        if (!next) return;
        playVideoClip(next);
      }, afterSeconds * 1000);
    }

    // ---------- reproducci√≥n robusta con test de CORS y fallback a fetch(blob) ----------
    async function playVideoClip(infoObj) {
      if (!infoObj) return;
      currentVideoObj = infoObj;
      usingChroma = true;
      // limpiar previous object url
      clearLastObjectURL();

      // intentar usar crossOrigin si el servidor lo permite
      try { fgVideo.crossOrigin = 'anonymous'; } catch(e){ console.warn(e); }

      // funci√≥n interna que configura src y espera loadeddata
      const setSrcAndWait = (src) => new Promise((resolve, reject) => {
        const onLoaded = () => { fgVideo.removeEventListener('loadeddata', onLoaded); resolve(true); };
        const onErr = (e) => { fgVideo.removeEventListener('error', onErr); reject(e || new Error('fgVideo error')); };
        fgVideo.addEventListener('loadeddata', onLoaded);
        fgVideo.addEventListener('error', onErr);
        fgVideo.src = src;
        fgVideo.load();
      });

      // primero intenta asignar la URL tal cual
      let assignedVia = 'direct';
      try {
        await setSrcAndWait(infoObj.src);
      } catch (err1) {
        console.warn('Asignaci√≥n directa fall√≥, intentando fetch->blob como fallback', err1);
        // intentar fetch y crear objectURL
        const blobUrl = await fetchAsObjectURL(infoObj.src);
        if (blobUrl) {
          lastObjectUrl = blobUrl;
          try {
            await setSrcAndWait(blobUrl);
            assignedVia = 'fetch-blob';
          } catch (err2) {
            console.warn('Asignaci√≥n desde blob fall√≥:', err2);
            activateFallback('Error cargando el clip. Mostrando fallback (sin recorte).');
            return;
          }
        } else {
          activateFallback('No se pudo obtener el clip (CORS). Mostrando fallback (sin recorte).');
          return;
        }
      }

      // Ajuste de tama√±o y mostrar canvas inicialmente (ocultamos el video nativo)
      adjustContainerToVideo(fgVideo, infoObj);
      fgCanvas.style.display = 'block';
      fgVideo.style.display = 'none';
      noticeBox.style.display = 'none';
      errorBox.style.display = 'none';

      // PRUEBA R√ÅPIDA: intentar leer 1 p√≠xel para comprobar si hay taint
      const ok = await tryDrawTest(fgVideo);
      if (!ok) {
        console.warn('Test de lectura fall√≥, intentando fetch->blob si no lo hicimos ya');
        if (assignedVia !== 'fetch-blob') {
          // intentar fetch si no lo hab√≠amos hecho
          const blobUrl2 = await fetchAsObjectURL(infoObj.src);
          if (blobUrl2) {
            clearLastObjectURL();
            lastObjectUrl = blobUrl2;
            try {
              await setSrcAndWait(blobUrl2);
              // reintentar test
              const ok2 = await tryDrawTest(fgVideo);
              if (!ok2) {
                activateFallback('No es posible procesar el v√≠deo para chroma (CORS). Mostrando sin recorte.');
                return;
              }
            } catch (err) {
              console.warn('Error al reasignar blob:', err);
              activateFallback('No es posible procesar el v√≠deo para chroma (CORS). Mostrando sin recorte.');
              return;
            }
          } else {
            activateFallback('No es posible procesar el v√≠deo para chroma (CORS). Mostrando sin recorte.');
            return;
          }
        } else {
          // ya vinimos por blob y aun as√≠ falla => no se puede procesar
          activateFallback('No es posible procesar el v√≠deo para chroma (CORS). Mostrando sin recorte.');
          return;
        }
      }

      // Si llegamos aqu√≠, la lectura de p√≠xeles funciona
      // aseguramos que fgCanvas visible y fgVideo oculto
      fgCanvas.style.display = 'block';
      fgVideo.style.display = 'none';

      // reproducir ambos (bg y front)
      const pVideoPlay = fgVideo.play().catch(()=>{});
      const pBgPlay = bgVideo.play().catch(()=>{});
      Promise.allSettled([pBgPlay, pVideoPlay]).then(results => {
        const anyRejected = results.some(r => r.status === 'rejected');
        if (anyRejected) playOverlay.style.display = 'flex';
        else playOverlay.style.display = 'none';
        if (!animationId && usingChroma) animationId = requestAnimationFrame(()=>processLoop(fgVideo, infoObj));
        showContainer();
      });

      fgVideo.onended = () => scheduleNextVideo(3, infoObj.id);
      fgVideo.onerror = (e) => {
        console.error('Error cargando clip (evento):', infoObj.src, e);
        activateFallback('Error cargando el clip. Mostrando fallback (sin recorte).');
      };
    }

    // ---------- inicializaci√≥n ----------
    function init() {
      setupControlsByProtocol();
      fgContainer.style.display = 'none';
      fgCanvas.style.display = 'none';
      fgVideo.style.display = 'none';

      fgContainer.addEventListener('click', () => {
        if (scheduledTimer) { clearTimeout(scheduledTimer); scheduledTimer = null; }
        const currentSrc = fgVideo.src ? fgVideo.src.split('/').pop() : null;
        let currentId = null;
        if (currentSrc) {
          for (const v of videoList) {
            if (v.src.endsWith(currentSrc)) { currentId = v.id; break; }
          }
        }
        scheduleNextVideo(3, currentId);
      });

      playBtn.addEventListener('click', () => {
        playOverlay.style.display = 'none';
        bgVideo.play().catch(()=>{});
        fgVideo.play().catch(()=>{});
      });

      [thresholdEl, diffEl, softEl].forEach(el => el.addEventListener('input', () => {
        thVal.textContent = parseFloat(thresholdEl.value).toFixed(2);
        diffVal.textContent = diffEl.value;
        softVal.textContent = softVal.value || softEl.value;
      }));

      // start random clip
      const first = pickRandomVideo(null);
      if (first) playVideoClip(first);

      window.addEventListener('resize', () => {
        if (currentVideoObj && fgVideo.videoWidth && fgVideo.videoHeight) {
          adjustContainerToVideo(fgVideo, currentVideoObj);
          placeContainerRandomly();
        }
      });
    }
    // ---- Manejo del video de fondo: mostrar poster mientras carga y revelar el video solo cuando se est√© reproduciendo ----
    window.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('bg-video');
      const overlay = document.getElementById('overlay');
      const tapToPlay = document.getElementById('tap-to-play');

      // Seguridad: atributos esenciales
      try { video.preload = video.getAttribute('preload') || 'auto'; } catch(e){ console.warn(e); }
      video.muted = true;
      video.playsInline = true;

      // funci√≥n que revela el video y oculta el overlay (con transici√≥n)
      const revealVideo = () => {
        // mostrar video
        video.style.opacity = '1';
        // ocultar overlay suavemente
        overlay.style.opacity = '0';
      };

      // cuando la transici√≥n de overlay termine y est√© en 0, lo quitamos del flujo (display:none)
      overlay.addEventListener('transitionend', (ev) => {
        if (ev.propertyName === 'opacity' && getComputedStyle(overlay).opacity === '0') {
          overlay.style.display = 'none';
        }
      });

      // REVELAR solo cuando el video realmente est√© reproduci√©ndose
      video.addEventListener('playing', () => {
        // si llega el evento playing sabemos que ya hay frames y audio (si aplica) reproduci√©ndose
        revealVideo();
      }, { once: true });

      // Intentamos reproducir en cuanto pueda cargarse (pero no ocultamos overlay hasta 'playing')
      video.addEventListener('canplaythrough', () => {
        video.play().catch(()=>{ /* autoplay bloqueado: esperamos click */ });
      }, { once: true });

      // Tambi√©n intentamos reproducir al menos en 'loadeddata'
      video.addEventListener('loadeddata', () => {
        video.play().catch(()=>{ /* autoplay bloqueado: esperamos click */ });
      }, { once: true });

      // Si despu√©s de X ms no hemos recibido 'playing', asumimos que el autoplay fue bloqueado:
      // intentamos reproducir al primer click del usuario (sin mostrar bot√≥n visual).
      const AUTOPLAY_TIMEOUT = 4000; // ms (ajustable)
      setTimeout(() => {
        // si a√∫n no est√° reproduci√©ndose (no se ha disparado 'playing')
        if (getComputedStyle(video).opacity === '0') {
          const tryPlay = () => {
            video.play().catch(()=>{});
          };
          // intentamos reproducir al click/tap del documento
          document.addEventListener('click', tryPlay, { once: true });
        }
      }, AUTOPLAY_TIMEOUT);

      // Nota: no forzamos ocultar overlay nunca antes de 'playing' ‚Äî esto evita el parpadeo a negro.
    });

    // ---- Audio autoplay robusto ----
    window.addEventListener('DOMContentLoaded', () => {
      const audio = document.getElementById('bg-music');
      try { audio.loop = true; } catch(e){ console.warn(e); }
      audio.volume = 0.8;
      audio.play().catch(() => {
        // si autoplay es bloqueado, reproducir al primer click
        document.addEventListener('click', () => { audio.play().catch(()=>{}); }, { once: true });
      });
      audio.addEventListener('ended', () => {
        try { audio.currentTime = 0; audio.play(); } catch (e) { console.warn(e); }
      });
    });

    // Abre en nueva pesta√±a/ventana
    function openInNewTab(url) {
      const win = window.open(url, '_blank', 'noopener,noreferrer');
      try { setTimeout(() => { if (typeof window.focus === 'function') window.focus(); }, 100); } catch(e){ console.warn(e); }
      return win;
    }

    // Normaliza texto (quita tildes y pasa a min√∫sculas)
    function normalizeText(s) {
      return String(s || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase();
    }

    const animes = [
      {id:1, title:"DAN DA DAN", img:"dan.jpg", rating:4.9, genres:["Acci√≥n","Sobrenatural","Comedia","Romance","Comedia oscura","Sh≈çnen"]},
      {id:2, title:"Jujutsu Kaisen", img:"Jujutsu.jpg", rating:4.9, genres:["Sobrenatural","Fantas√≠a oscura","Acci√≥n","Nekketsu","Sh≈çnen"]},
      {id:3, title:"Konosuba", img:"konosubaportada.jpg", rating:4.8, genres:["Aventura","Comedia","Fantas√≠a","Sobrenatural","Isekai","Ecchi","Sh≈çnen"]},
      {id:4, title:"Re:Zero ‚àí Empezar vida en otro mundo", img:"rezero.png", rating:4.8, genres:["Acci√≥n","Aventura","Drama","Fantas√≠a oscura","Romance","Thriller psicol√≥gico","Terror psicol√≥gico","Isekai","Sh≈çnen"]},
      {id:5, title:"Mushoku Tensei", img:"mushoku.jpg", rating:4.8, genres:["Isekai","Ecchi","Romance","Harem","Acci√≥n","Aventura","Drama","Fantas√≠a","Seinen"]},
      {id:6, title:"Tensei Shitara Slime Datta Ken", aliases: ["That Time I Got Reincarnated as a Slime"], img:"slime.jpg", rating:4.9, genres:["Comedia","Isekai","Acci√≥n","Aventura","Fantas√≠a","Sh≈çnen"]},
      {id:7, title:"Saga of Tanya the Evil", aliases: ["Y≈çjo Senki"], img:"tanya1.jpg", rating:4.8, genres:["Acci√≥n","Aventura","Fantas√≠a","Militar","Drama","Ciencia ficci√≥n","Seinen"]},
      {id:8, title:"Akame Ga Kill", aliases: ["Akame ga Kiru"], img:"Akame1.jpg", rating:4.6, genres:["Acci√≥n","Aventura","Drama","Fantas√≠a oscura","Romance","Tragedia","Sh≈çnen"]},
      {id:9, title:"To Be Hero X", img:"hero11.jpg", rating:4.8, genres:["Acci√≥n","Comedia","Animaci√≥n","Fantas√≠a","Superh√©roes","Seinen"]},
      {id:10, title:"Demon Slayer", aliases: ["Kimetsu no Yaiba"], img:"demon.jpg", rating:4.9, genres:["Acci√≥n","Fantas√≠a oscura","Aventura","Sobrenatural","Drama","Sh≈çnen"]},
      {id:11, title:"Maou 2099", img:"maou2099portada.jpg", rating:4.7, genres:["Ciencia ficci√≥n","Isekai Inverso","Acci√≥n","Fantas√≠a","Cyberpunk","Sh≈çnen"]},
      {id:12, title:"Wistoria: Wand and Sword", img:"wistoria.jpg", rating:4.8, genres:["Fantas√≠a","Aventura","Sh≈çnen"]},
      {id:13, title:"Izure Saikyou no Renkinjutsushi", aliases: ["Possibly the Greatest Alchemist of All Time"], img:"Izure.jpg", rating:4.6, genres:["Aventura","Comedia","Fantas√≠a","Isekai","Sh≈çnen"]},
      {id:14, title:"Alya Sometimes Hides Her Feelings in Russian", aliases: ["Tokidoki Bosotto Russia-go de Dereru Tonari no Alya-san"], img:"alia.jpg", rating:4.8, genres:["Comedia","Romance","Romance escolar","Escolar","Josei"]},
      {id:15, title:"Reborn as a Vending Machine, I Now Wander the Dungeon", aliases: ["Jid≈çhanbaiki ni Umarekawatta Ore wa Meiky≈´ ni Samay≈ç"], img:"jidou.jpg", rating:4.1, genres:["Fantas√≠a","Isekai","Sh≈çnen"]},
      {id:16, title:"kimi to boku no saigo no senjou", aliases: ["Our Last Crusade or the Rise of a New World"], img:"kimi22222.jpg", rating:4.5, genres:["Acci√≥n","Fantas√≠a","Romance","Militar","Seinen"]},
      {id:17, title:"The Gorilla God's Go- To Girl", aliases: ["Gorilla no Kami Kara Kago Sareta Reij≈ç wa ≈åritsu Kishidan de Kawaiigareru"], img:"gorila11.jpg", rating:4.5, genres:["Fantas√≠a","Comedia","Escolar","Romance","Sh≈çjo"]},
      {id:18, title:"Chainsaw Man", img:"chaiportada.jpg", rating:4.9, genres:["Fantas√≠a oscura","Acci√≥n","Comedia oscura","Sh≈çnen"]},
      {id:19, title:"The Rising of the Shield Hero", aliases: ["Tate no Yuusha no Nariagari","El H√©roe del Escudo"], img:"heroedelescudoportada.jpg", rating:4.7, genres:["Aventura","Drama","Fantas√≠a","Acci√≥n","Romance","Isekai","Seinen"]},
      {id:20, title:"Overflow", img:"overflow.jpg", rating:4.6, genres:["Hentai","Escolar","Romance","Harem","Incesto","Seijin"]},
      {id:21, title:"Shiunji-ke no Kodomotachi", img:"Shiux.jpg", rating:4.6, genres:["Comedia","Romance","Drama","Harem","Slice of Life","Seinen"]},
      {id:22, title:"Goblin Slayer", img:"goblinslayerportada.jpg", rating:4.7, genres:["Fantas√≠a oscura","Horror","Aventura","Fantas√≠a","Seinen"]},
      {id:23, title:"Kanchigai no Atelier Meister", img:"atelier1.jpg", rating:4.6, genres:["Aventura","Comedia","Fantas√≠a","Acci√≥n","Sh≈çnen"]},
      {id:24, title:"Definitivamente. ¬°No me gusta mi hermano para nada!", img:"Oni.jpg", rating:4.1, genres:["Comedia","Romance","Slice of Life","Harem","Ecchi","Seinen"]},
      {id:25, title:"Kaiju No. 8", img:"kaijuportada.jpg", rating:4.9, genres:["Sobrenatural","Fantas√≠a oscura","Acci√≥n","Ciencia ficci√≥n","Aventura","Comedia","Kaiju","Sh≈çnen"]},
      {id:26, title:"Zootopia", img:"zootopiaportada.jpg", rating:4.7, genres:["Aventura","Comedia","Policial","Infantil","Familiar","Misterio","Animaci√≥n","Dibujo Animado","Kodomo"]},
      {id:27, title:"Clevatess -Majuu no Ou to Akago", img:"Clevatessportada.jpg", rating:4.8, genres:["Acci√≥n","Fantas√≠a","Drama","Seinen"]},
      {id:28, title:"Dr. Stone", img:"Dr._Stoneportada.jpg", rating:4.8, genres:["Ciencia ficci√≥n","Aventura","Comedia","Post-apocal√≠ptico","Sh≈çnen"]},
      {id:29, title:"One Piece (Live Action)", img:"onepieceportada.jpg", rating:4.8, genres:["Aventura","Comedia","Acci√≥n","Fantas√≠a","Drama","Sh≈çnen"]},
      {id:30, title:"Shoujo Ramune", img:"shoujoramuneportada.jpg", rating:4.3, genres:["Hentai","Harem","Incesto","Seijin"]},
      {id:31, title:"To Your Eternity", aliases: ["Fumetsu no Anata e"], img:"fumetsuportada.jpg", rating:4.8, genres:["Fantas√≠a","Drama","Aventura","Sobrenatural","Sh≈çnen"]},
      {id:32, title:"Tsugunai Subbed", img:"TsugunaiSubbed.jpg", rating:4.8, genres:["Hentai","Harem","Escolar","Seijin"]},
      {id:33, title:"Blue Lock", aliases: ["Yoichi Isagi"], img:"Bluelockportada.jpg", rating:4.8, genres:["Thriller","Psicol√≥gico","Deportivo","Survival Game","Sh≈çnen"]},
      {id:34, title:"Magic Maker: Isekai Mahou no Tsukurikata", aliases: ["Magic Maker: How to Make Magic in Another World"], img:"magic maker.jpg", rating:4.4, genres:["Fantas√≠a","Isekai","Aventura","Slice of Life","Sh≈çnen"]},
      {id:35, title:"Tsuyokute New Saga", aliases: ["New Saga"], img:"New Saga.jpg", rating:4.5, genres:["Fantas√≠a","Isekai","Aventura","Comedia","Acci√≥n","Drama","Slice of Life","Sh≈çnen"]},
      {id:36, title:"Gachiakuta", img:"Gachiakuta.jpg", rating:4.9, genres:["Fantas√≠a","Aventura","Acci√≥n","Fantas√≠a oscura","Sh≈çnen"]},
      {id:37, title:"Shinsei Kourin Dacryon Luna", img:"Shinsei Kourin Dacryon Luna portada.jpg", rating:4.0, genres:["Tent√°culos","Hentai","Fantas√≠a","Fantas√≠a oscura","Seijin"]},
      {id:38, title:"Kami-tachi ni Hirowareta Otoko", aliases: ["By the Grace of the Gods"], img:"Kamitachi.jpg", rating:4.7, genres:["Fantas√≠a","Aventura","Slice of Life","Isekai","Sh≈çnen"]},
      {id:39, title:"Ore dake Haireru Kakushi Dungeon", aliases: ["The Hidden Dungeon Only I Can Enter"], img:"oredake.jpg", rating:4.5, genres:["Fantas√≠a","Comedia","Harem","Ecchi","Acci√≥n","Romance","Sh≈çnen"]},
      {id:40, title:"One Punch-Man", aliases: ["One-Punch Man"], img:"onepunch.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Ciencia ficci√≥n","Superh√©roes","Seinen"]},
      {id:41, title:"Mashle", aliases: ["Mash Burnedead"], img:"mashle1.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Aventura","Sh≈çnen"]},
      {id:42, title:"Los Diarios de la Boticaria", aliases: ["Kusuriya no Hitorigoto","The Apothecary Diaries"], img:"maomaot1.jpg", rating:4.9, genres:["Drama","Misterio","Romance","Sh≈çjo"]},
      {id:43, title:"Maplestar", img:"pm.png", rating:5.0, genres:["Hentai","Animaci√≥n","Seijin"]},
      {id:44, title:"Uzumaki", img:"uzumakii.jpg", rating:4.2, genres:["Horror","Seinen"]},
      {id:45, title:"Tondemo Skill de Isekai Hourou Meshi", aliases: ["Campfire Cooking in Another World with My Absurd Skills"], img:"todemo.jpg", rating:4.9, genres:["Comedia","Fantas√≠a","Slice of Life","Cocina","Aventura","Sh≈çnen","Isekai"]},
      {id:46, title:"My Dress-Up Darling", aliases: ["Sono Bisque Doll wa Koi wo Suru"], img:"muneca.jpg", rating:4.9, genres:["Comedia","Romance","Slice of Life","Escolar","Cosplay","Seinen"]},
      {id:47, title:"Hazbin Hotel", aliases: ["Hotel Hazbin"], img:"hhzz.jpg", rating:4.8, genres:["Comedia","Musical","Drama","Animaci√≥n","Policial","Seijin"]},
      {id:48, title:"The Eminence in Shadow", aliases: ["Kage no Jitsuryokusha ni Naritakute!"], img:"shadow.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Isekai","Harem","Steampunk","Sh≈çnen"]},
      {id:49, title:"Spy √ó Family", img:"spy.jpg", rating:4.9, genres:["Comedia","Drama","Fantas√≠a","Familiar","Espionaje","Sh≈çnen"]},
      {id:50, title:"Black Clover", img:"portbla.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Aventura","Sh≈çnen"]},
      {id:51, title:"My Hero Academia", aliases: ["Boku no Hero"], img:"sgsgsdseg.jpg", rating:4.7, genres:["Superh√©roes","Ciencia ficci√≥n","Comedia","Drama","Acci√≥n","Fantas√≠a","Escolar","Aventura","Sh≈çnen"]},
      {id:52, title:"Kakkou no Linazuke", aliases: ["A Couple of Cuckoos"], img:"pordf.jpg", rating:4.5, genres:["Romance","Comedia","Escolar","Harem","Sh≈çnen"]},

    ];


    function render(list) {
      const grid = document.getElementById('grid');
      if (!list || list.length === 0) {
        grid.innerHTML = `
          <div class="no-results" role="status" aria-live="polite">
            <div class="title shimmer">¬°Ups! No se encontraron resultados que coincidan con la b√∫squeda.</div>
            <div class="subtitle">¬øNo lo encuentras? ü§î Puede que lo hayas escrito con un error ‚úèÔ∏è o que todav√≠a no lo haya subido ‚è≥. Si quieres que lo agregue, deja el t√≠tulo en los comentarios de mi canal de YouTube üé• o en mi TikTok üéµ. ¬°Gracias por ayudarme a mejorar la colecci√≥n! üôèüíú</div>
            <div class="sparkles">
              <button class="btn-reset" id="btn-reset">Entiendo üëå</button>
            </div>
          </div>
        `;
        // enlazar el bot√≥n limpiar dentro del mensaje
        const btn = document.getElementById('btn-reset');
        if (btn) btn.addEventListener('click', () => {
          document.getElementById('search').value = '';
          document.getElementById('genre-select').value = '';
          document.getElementById('demographic-select').value = '';
          document.getElementById('rating-select').value = '';
          filtro();
          document.getElementById('search').focus();
        });
        return;
      }

      grid.innerHTML = list.map(a => `
        <div class="card" onclick="location='anime-detail.html?id=${a.id}'" role="link" tabindex="0">
          <img src="${a.img}" alt="${a.title}">
          <div class="info">
            <strong>${a.title}</strong>
            <span>‚≠ê ${a.rating.toFixed(1)}</span>
          </div>
        </div>
      `).join('');
      const observer = new IntersectionObserver(entries => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            e.target.classList.add('visible');
            observer.unobserve(e.target);
          }
        });
      }, {threshold:0.2});
      document.querySelectorAll('.card').forEach(c => observer.observe(c));
    }

    // Actualiza el contador visible en header
    function updateResultsCount(count) {
      const el = document.getElementById('results-count');
      if (el) el.textContent = count;
    }

    /* ---------- DEBOUNCE (tu versi√≥n) ---------- */
    function debounce(fn, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), wait);
      };
    }
    const debouncedFiltro = debounce(filtro, 200);

    /* ---------- FILTRO (adaptado: startsWith + orden alfab√©tico y contador) ---------- */
    function getBestTitleForSort(a) {
      // Devuelve la mejor cadena normalizada entre title y aliases para ordenar
      const titles = [a.title].concat(a.aliases || []);
      const norm = titles.map(t => normalizeText(t));
      // Elegimos la forma m√°s "corta" lexicogr√°ficamente para estabilidad
      norm.sort();
      return norm[0];
    }

    function filtro(){
      const qRaw   = document.getElementById('search').value || '';
      const q = qRaw.trim();
      const qn = normalizeText(q);
      const g   = document.getElementById('genre-select').value;
      const d   = document.getElementById('demographic-select').value;
      const cat = document.getElementById('rating-select').value;

      // Filtrado: startsWith en t√≠tulo/alias (prefijo), ignorando tildes
      const filtrados = animes.filter(a => {
        const titles = [a.title].concat(a.aliases || []);
        const matchesText = !qn || titles.some(t => normalizeText(t).startsWith(qn));
        const byGenre  = !g || a.genres.includes(g);
        const byDemo   = !d || a.genres.includes(d);
        let byRating = true;
        if(cat==='excellent') byRating = a.rating >= 4.8;
        else if(cat==='good')    byRating = a.rating >= 4.6 && a.rating < 4.8;
        else if(cat==='regular') byRating = a.rating < 4.6;
        return matchesText && byGenre && byDemo && byRating;
      });

      // Orden: primero los que empiecen por la query, luego orden alfab√©tico por el t√≠tulo (normalizado)
      let resultList = filtrados.slice();

      if (qn) {
        resultList.sort((A, B) => {
          const titlesA = [A.title].concat(A.aliases || []).map(t => normalizeText(t));
          const titlesB = [B.title].concat(B.aliases || []).map(t => normalizeText(t));
          const aStarts = titlesA.some(t => t.startsWith(qn));
          const bStarts = titlesB.some(t => t.startsWith(qn));
          if (aStarts !== bStarts) return aStarts ? -1 : 1;
          // si ambos empiezan o ninguno empieza: ordenar alfab√©ticamente por la mejor forma normalizada
          const na = getBestTitleForSort(A);
          const nb = getBestTitleForSort(B);
          if (na < nb) return -1;
          if (na > nb) return 1;
          return 0;
        });
      } else {
        // Si no hay query: ordenar alfab√©ticamente por t√≠tulo normalizado (opcional; si prefieres mantener shuffle, quita esto)
        resultList.sort((A,B) => {
          const na = normalizeText(A.title);
          const nb = normalizeText(B.title);
          if (na < nb) return -1;
          if (na > nb) return 1;
          return 0;
        });
      }

      // Renderizar y actualizar contador
      render(resultList);
      updateResultsCount(resultList.length);
    }

    // Funci√≥n para barajar (Fisher-Yates)
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Barajar el arreglo al cargar la p√°gina (se mantiene el comportamiento inicial)
    shuffleArray(animes);

    // Render inicial y establecer contador inicial
    render(animes);
    updateResultsCount(animes.length);

    // Scroll header change
    window.addEventListener('scroll', () => {
      document.querySelector('header').classList.toggle('scrolled', window.scrollY > 50);
    });

    // Enlazar b√∫squeda & selects
    if (document.getElementById('search')) {
      document.getElementById('search').addEventListener('input', debouncedFiltro);
      document.getElementById('search').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); filtro(); }
      });
    }
    document.getElementById('genre-select').addEventListener('change', filtro);
    document.getElementById('rating-select').addEventListener('change', filtro);
    document.getElementById('demographic-select').addEventListener('change', filtro);

/* --- Popup compacto para selects en m√≥vil: versi√≥n mejorada --- */
(function(){
  function isMobileWidth(){ return window.matchMedia('(max-width: 780px)').matches; }
  // solo activamos en m√≥vil
  if (!isMobileWidth()) return;

  const selects = Array.from(document.querySelectorAll('header select'));
  let currentPopup = null;
  let currentTrigger = null;

  function closePopup() {
    if (currentPopup) { currentPopup.remove(); currentPopup = null; currentTrigger = null; }
    document.removeEventListener('pointerdown', onDocPointerDown, true);
    document.removeEventListener('touchstart', onDocPointerDown, true);
  }
  function onDocPointerDown(e) {
    if (!currentPopup) return;
    if (currentPopup.contains(e.target) || (currentTrigger && currentTrigger.contains(e.target))) return;
    closePopup();
  }

  function openPopupForSelect(sel) {
    closePopup();
    const popup = document.createElement('div');
    popup.className = 'mobile-select-popup';
    popup.setAttribute('role','listbox');

    Array.from(sel.options).forEach((opt, idx) => {
      const div = document.createElement('div');
      div.className = 'opt';
      div.textContent = opt.textContent;
      div.dataset.value = opt.value;
      div.setAttribute('role','option');
      if (opt.selected) div.setAttribute('aria-selected','true');
      div.addEventListener('click', function(e){
        sel.value = this.dataset.value;
        // dispatch change
        const evt = new Event('change', { bubbles: true });
        sel.dispatchEvent(evt);
        if (typeof filtro === 'function') filtro();
        closePopup();
        e.stopPropagation();
      });
      popup.appendChild(div);
    });

    document.body.appendChild(popup);
    currentPopup = popup;
    currentTrigger = sel;

    // posicionar popup
    const rect = sel.getBoundingClientRect();
    // forzamos width similar al select pero no mayor que el viewport
    const preferredWidth = Math.min(Math.max(rect.width, 140), window.innerWidth - 16);
    popup.style.minWidth = preferredWidth + 'px';

    // calcular top/left con ajuste para no salirse
    const popupRect = popup.getBoundingClientRect();
    let top = rect.bottom + window.scrollY + 6;
    let left = rect.left + window.scrollX;
    // si no cabe a la derecha, ajusta
    if (left + preferredWidth > window.innerWidth - 8) left = Math.max(8, window.innerWidth - preferredWidth - 8);
    // si no cabe abajo, pon encima
    if (top + popupRect.height > window.innerHeight + window.scrollY - 8) {
      top = rect.top + window.scrollY - popupRect.height - 6;
    }
    popup.style.left = left + 'px';
    popup.style.top = top + 'px';

    // cerrar al click/tap fuera
    setTimeout(() => {
      document.addEventListener('pointerdown', onDocPointerDown, true);
      document.addEventListener('touchstart', onDocPointerDown, true);
    }, 10);
  }

  // attach handlers: use pointerdown/touchstart to try to prevent native pickers
  selects.forEach(sel => {
    // ensure the select is non-passive interactive
    const handler = function(e){
      // if user long-presses to pick native, some browsers may ignore preventDefault.
      e.preventDefault();
      e.stopPropagation();
      openPopupForSelect(sel);
    };
    sel.addEventListener('pointerdown', handler, { passive: false });
    sel.addEventListener('touchstart', handler, { passive: false });
    // fallback: also support click for desktops that simulate mobile
    sel.addEventListener('click', function(e){
      // only open our popup on mobile widths
      if (isMobileWidth()) {
        e.preventDefault(); e.stopPropagation();
        openPopupForSelect(sel);
      }
    }, { passive: false });
  });

  // cerrar al rotar/resize o salir de m√≥vil
  window.addEventListener('orientationchange', closePopup);
  window.addEventListener('resize', () => {
    if (!isMobileWidth()) closePopup();
  });
})();
  </script>
</body>
</html>